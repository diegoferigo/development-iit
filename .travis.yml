language: generic

services:
  - docker

os:
  - linux

stages:
  - tools
  - development

script:
  - cd $TRAVIS_BUILD_DIR/$IMAGE_FOLDER
  - >-
    docker build --rm \
      --build-arg BASE_IMAGE=$DOCKER_BASE_IMAGE \
      $EXTRA_BUILD_ARGS \
      -t $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG \
      .

after_success:
  - if ! [[ "$TRAVIS_REPO_SLUG" = "diegoferigo/development-iit" && "$TRAVIS_BRANCH" = "master" && "$TRAVIS_PULL_REQUEST" = "false" ]] ; then travis_terminate 0 ; fi
  - docker login --username=$DOCKERHUB_USERNAME --password=$DOCKERHUB_PASSWORD
  - docker push $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG
  - >-
    if [ "$IS_LATEST" = "true" ] ; then
      docker tag $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG $DOCKER_IMAGE_NAME:latest
      docker push $DOCKER_IMAGE_NAME:latest
    fi

jobs:
  include:
    # Disable test stage
    - stage: test
      if: env(DUMMYVAR) is present
    # =====
    # TOOLS
    # =====
    - &tools_template
      stage: tools
      env:
        - DOCKER_BASE_IMAGE="ubuntu:xenial"
        - DOCKER_IMAGE_NAME="diegoferigo/tools"
        - DOCKER_IMAGE_TAG="xenial"
        - IMAGE_FOLDER="Tools"
        - IS_LATEST=false
        - PUSH_TO_DOCKERHUB=false
    - <<: *tools_template
      env:
        - DOCKER_BASE_IMAGE="ubuntu:bionic"
        - DOCKER_IMAGE_NAME="diegoferigo/tools"
        - DOCKER_IMAGE_TAG="bionic"
        - IMAGE_FOLDER="Tools"
        - IS_LATEST=true
        - PUSH_TO_DOCKERHUB=true
    - <<: *tools_template
      env:
        - DOCKER_BASE_IMAGE="nvidia/opengl:1.0-glvnd-runtime-ubuntu18.04"
        - DOCKER_IMAGE_NAME="diegoferigo/tools"
        - DOCKER_IMAGE_TAG="nvidia"
        - IMAGE_FOLDER="Tools"
        - IS_LATEST=false
        - PUSH_TO_DOCKERHUB=true
    # ===========
    # DEVELOPMENT
    # ===========
    - &development_template
      stage: development
      env:
        - DOCKER_BASE_IMAGE="diegoferigo/tools:xenial"
        - DOCKER_IMAGE_NAME="diegoferigo/development"
        - DOCKER_IMAGE_TAG="xenial-master"
        - EXTRA_BUILD_ARGS="--build-arg SOURCES_GIT_BRANCH=master"
        - IMAGE_FOLDER="Development"
        - IS_LATEST=false
        - PUSH_TO_DOCKERHUB=false
    - <<: *development_template
      env:
        - DOCKER_BASE_IMAGE="diegoferigo/tools:xenial"
        - DOCKER_IMAGE_NAME="diegoferigo/development"
        - DOCKER_IMAGE_TAG="xenial-devel"
        - EXTRA_BUILD_ARGS="--build-arg SOURCES_GIT_BRANCH=devel"
        - IMAGE_FOLDER="Development"
        - IS_LATEST=false
        - PUSH_TO_DOCKERHUB=false
    - <<: *development_template
      env:
        - DOCKER_BASE_IMAGE="diegoferigo/tools:bionic"
        - DOCKER_IMAGE_NAME="diegoferigo/development"
        - DOCKER_IMAGE_TAG="bionic-master"
        - EXTRA_BUILD_ARGS="--build-arg SOURCES_GIT_BRANCH=master"
        - IMAGE_FOLDER="Development"
        - IS_LATEST=true
        - PUSH_TO_DOCKERHUB=false
    - <<: *development_template
      env:
        - DOCKER_BASE_IMAGE="diegoferigo/tools:bionic"
        - DOCKER_IMAGE_NAME="diegoferigo/development"
        - DOCKER_IMAGE_TAG="bionic-devel"
        - EXTRA_BUILD_ARGS="--build-arg SOURCES_GIT_BRANCH=devel"
        - IMAGE_FOLDER="Development"
        - IS_LATEST=false
        - PUSH_TO_DOCKERHUB=false
    - <<: *development_template
      env:
        - DOCKER_BASE_IMAGE="diegoferigo/tools:nvidia"
        - DOCKER_IMAGE_NAME="diegoferigo/development"
        - DOCKER_IMAGE_TAG="nvidia-devel"
        - EXTRA_BUILD_ARGS="--build-arg SOURCES_GIT_BRANCH=devel"
        - IMAGE_FOLDER="Development"
        - IS_LATEST=false
        - PUSH_TO_DOCKERHUB=true
